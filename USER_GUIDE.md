# 认证中继服务 - 用户使用手册

本手册详细介绍认证中继服务 Web 管理界面的使用方法。

---

## 目录

- [1. 简介](#1-简介)
- [2. 登录系统](#2-登录系统)
- [3. 管理员功能](#3-管理员功能)
  - [3.1 仪表盘](#31-仪表盘)
  - [3.2 SSO 平台管理](#32-sso-平台管理)
  - [3.3 操作日志](#33-操作日志)
- [4. 普通用户功能](#4-普通用户功能)
  - [4.1 首页](#41-首页)
  - [4.2 平台列表](#42-平台列表)
  - [4.3 字段账号管理](#43-字段账号管理)
- [5. 认证测试](#5-认证测试)
- [6. 缓存管理](#6-缓存管理)
- [7. 常见问题](#7-常见问题)

---

## 1. 简介

认证中继服务是一个用于 Web 自动化脚本的 SSO 认证工具。它通过模拟表单登录获取 Cookie，供 Playwright 等自动化脚本使用。

**主要功能：**
- 多 SSO 平台支持：可配置多个不同的 SSO 登录平台
- 多账户管理：每个平台支持多个字段账号
- Cookie 缓存：自动缓存 Cookie，避免重复登录
- 审计日志：记录所有操作，便于追踪

**用户角色：**

| 角色 | 权限范围 |
|------|----------|
| 管理员 (admin) | 全部功能：SSO 平台配置、字段账号管理、缓存管理、日志查看 |
| 普通用户 (user) | 字段账号增删改查、获取 Cookie、缓存管理 |

---

## 2. 登录系统

访问系统 URL 后，您将看到登录页面。

<!-- 截图：登录页面 -->
![登录页面](screenshots/login.png)

**操作步骤：**

1. 在输入框中输入您的 API Key
2. 点击「确认访问」按钮
3. 系统将自动验证 API Key 并跳转到对应的界面
   - 使用管理员 API Key 登录后进入管理员仪表盘
   - 使用普通用户 API Key 登录后进入用户首页

**注意事项：**
- API Key 由系统管理员提供
- 如果 API Key 无效，页面将显示错误提示
- 登录状态会保存在浏览器中，下次访问无需重新登录

---

## 3. 管理员功能

管理员拥有系统的全部管理权限，可以配置 SSO 平台、管理字段账号、查看操作日志等。

### 3.1 仪表盘

仪表盘是管理员登录后的首页，提供系统运行状态的概览。

<!-- 截图：管理员仪表盘 -->
![管理员仪表盘](screenshots/admin-dashboard.png)

**页面组成：**

#### 统计卡片

页面顶部显示三个统计卡片：

| 卡片 | 说明 |
|------|------|
| SSO 平台数量 | 当前系统中配置的 SSO 平台总数 |
| 字段账号数量 | 所有平台下的账号总数 |
| 缓存的 Cookie | 当前内存中缓存的 Cookie 会话数 |

#### 认证测试

在仪表盘可以快速测试认证功能：

1. 输入 **Provider ID**（SSO 平台标识）
2. 输入 **Key**（字段账号标识）
3. 点击「测试认证」按钮
4. 查看测试结果

<!-- 截图：认证测试成功 -->
![认证测试](screenshots/admin-auth-test.png)

#### 缓存状态

显示当前缓存的 Cookie 详情：
- 按平台分组显示
- 显示每个字段账号的缓存条目
- 显示验证次数

点击「清空缓存」按钮可以清除所有缓存。

---

### 3.2 SSO 平台管理

管理员可以添加、编辑、删除 SSO 平台配置。

点击侧边栏的「SSO 平台」进入平台管理页面。

<!-- 截图：SSO 平台列表 -->
![SSO 平台列表](screenshots/admin-providers.png)

#### 添加新平台

1. 点击右上角「添加平台」按钮
2. 在弹出的表单中填写配置信息
3. 点击「保存」完成创建

<!-- 截图：添加平台表单 -->
![添加平台](screenshots/admin-provider-form.png)

**配置参数说明：**

| 参数 | 必填 | 说明 |
|------|------|------|
| 平台 ID | 是 | 唯一标识符，如 `sso_company` |
| 平台名称 | 是 | 显示名称，如「公司 SSO」 |
| 登录 URL | 是 | SSO 登录页面的完整 URL |
| 用户名选择器 | 是 | 用户名输入框的 CSS 选择器，如 `#username` |
| 密码选择器 | 是 | 密码输入框的 CSS 选择器，如 `#password` |
| 登录按钮选择器 | 是 | 登录按钮的 CSS 选择器，如 `#submit` |
| 登录成功标识 | 否 | 判断登录成功的标识 |
| 标识类型 | 否 | `url_contains`（URL 包含）/ `url_equals`（URL 等于）/ `element_exists`（元素存在） |
| 验证 URL | 否 | 用于验证 Cookie 是否有效的 URL |
| 失效标识 | 否 | 判断 Cookie 失效的标识 |
| 登录后等待 | 否 | 登录后等待时间（毫秒），默认 2000 |

**CSS 选择器示例：**
- `#username` - 选择 id 为 username 的元素
- `.login-input` - 选择 class 为 login-input 的元素
- `input[name="user"]` - 选择 name 属性为 user 的 input 元素
- `button[type="submit"]` - 选择 type 为 submit 的 button 元素

#### 查看/编辑平台

点击平台列表中的平台 ID 或「详情」链接，进入平台详情页面。

<!-- 截图：平台详情页面 -->
![平台详情](screenshots/admin-provider-detail.png)

在详情页面可以：
- 查看平台配置信息
- 编辑平台配置（点击「编辑」按钮）
- 管理字段账号
- 清空该平台的缓存

#### 删除平台

点击平台列表中的「删除」按钮，确认后将删除该平台及其所有字段账号。

> **警告：** 删除平台操作不可恢复，请谨慎操作。

---

### 3.3 操作日志

管理员可以查看系统的所有操作记录。

点击侧边栏的「操作日志」进入日志页面。

<!-- 截图：操作日志页面 -->
![操作日志](screenshots/admin-logs.png)

#### 日志统计

页面顶部显示日志统计卡片：
- 总日志数
- 成功操作数
- 失败操作数
- 成功率

#### 筛选日志

使用筛选器可以快速定位日志：

| 筛选条件 | 说明 |
|----------|------|
| 操作类型 | 创建平台、更新平台、创建字段、认证成功等 |
| 资源类型 | SSO 平台、字段账号、认证、缓存 |
| 状态 | 成功 / 失败 |

点击「重置」按钮清除所有筛选条件。

#### 查看日志详情

点击日志行可以展开查看详细信息，包括：
- 具体的操作参数
- 错误信息（如果失败）
- 更新的字段列表

<!-- 截图：日志详情展开 -->
![日志详情](screenshots/admin-log-detail.png)

#### 分页

日志列表支持分页浏览，每页显示 20 条记录。

---

## 4. 普通用户功能

普通用户可以管理字段账号、测试认证、管理缓存。

### 4.1 首页

普通用户登录后进入首页。

<!-- 截图：用户首页 -->
![用户首页](screenshots/user-home.png)

**页面组成：**

#### 快速统计

显示可用平台数量和字段账号总数。

#### 快速认证测试

可以直接在首页测试认证：

1. 从下拉列表选择平台
2. 输入字段 Key
3. 点击「测试认证」

#### 最近平台

显示最近的平台列表，点击可快速进入平台详情。

---

### 4.2 平台列表

点击侧边栏的「平台列表」查看所有可用的 SSO 平台。

<!-- 截图：用户平台列表 -->
![用户平台列表](screenshots/user-providers.png)

平台以卡片形式展示，显示：
- 平台名称和 ID
- 字段账号数量
- 登录 URL

点击平台卡片进入该平台的字段账号管理页面。

---

### 4.3 字段账号管理

在平台详情页面可以管理字段账号。

<!-- 截图：字段账号管理 -->
![字段账号管理](screenshots/user-fields.png)

#### 添加字段账号

1. 点击「添加字段」按钮
2. 填写字段信息：
   - **Key**：字段唯一标识，如 `user1`、`test_account`
   - **用户名**：SSO 登录用户名
   - **密码**：SSO 登录密码
3. 点击「保存」完成添加

<!-- 截图：添加字段表单 -->
![添加字段](screenshots/user-field-form.png)

> **说明：** 密码会使用加密方式存储，系统中不会保存明文密码。

#### 编辑字段账号

1. 点击字段列表中的「编辑」按钮
2. 修改用户名或密码
3. 点击「保存」完成修改

> **注意：** 修改密码后，该字段的缓存会自动失效，下次获取 Cookie 时会重新登录。

#### 删除字段账号

点击字段列表中的「删除」按钮，确认后删除该字段账号。

#### 测试字段认证

点击字段列表中的「测试」按钮，可以立即测试该账号的认证是否正常。

---

## 5. 认证测试

认证测试功能用于验证配置是否正确。

**测试入口：**
- 管理员仪表盘 → 认证测试区域
- 用户首页 → 快速认证测试
- 平台详情页 → 字段列表中的「测试」按钮

**测试流程：**

1. 选择或输入平台 ID
2. 输入字段 Key
3. 点击测试按钮
4. 等待认证完成（可能需要几秒钟）
5. 查看结果

**测试结果说明：**

| 结果 | 说明 |
|------|------|
| 认证成功！获取到 X 个 Cookie | 登录成功，Cookie 已获取并缓存 |
| 认证成功！获取到 X 个 Cookie（来自缓存） | Cookie 来自缓存，无需重新登录 |
| 认证失败: xxx | 登录失败，显示具体错误原因 |

**常见失败原因：**
- 用户名或密码错误
- CSS 选择器配置不正确
- 登录成功标识配置有误
- 网络连接问题

---

## 6. 缓存管理

系统会自动缓存获取的 Cookie，避免频繁登录。

**缓存入口：**
- 管理员仪表盘 → 缓存状态区域
- 平台详情页 → 缓存管理

**缓存操作：**

| 操作 | 说明 |
|------|------|
| 清空所有缓存 | 清除系统中所有平台的 Cookie 缓存 |
| 清空平台缓存 | 清除指定平台下所有字段的缓存 |
| 清空字段缓存 | 清除指定字段的缓存 |

<!-- 截图：缓存状态 -->
![缓存状态](screenshots/cache-status.png)

**何时需要清空缓存：**
- 修改了字段账号的密码
- SSO 平台的 Cookie 已过期
- 需要强制重新登录获取新 Cookie

---

## 7. 常见问题

### Q1: 认证失败，提示"选择器未找到"

**可能原因：**
- CSS 选择器配置不正确
- 登录页面结构发生变化

**解决方法：**
1. 使用浏览器开发者工具（F12）检查登录页面
2. 确认输入框和按钮的选择器
3. 更新平台配置中的选择器

### Q2: 认证成功但 Cookie 无法使用

**可能原因：**
- Cookie 验证配置不正确
- Cookie 已过期

**解决方法：**
1. 检查平台配置中的「验证 URL」和「失效标识」
2. 清空该字段的缓存，重新获取 Cookie

### Q3: 登录后等待时间过长

**可能原因：**
- 登录成功标识配置不当，导致系统无法判断登录完成

**解决方法：**
1. 配置正确的「登录成功标识」
2. 适当调整「登录后等待时间」

### Q4: 如何获取 API Key？

API Key 由系统管理员在配置文件 `config.yaml` 中设置：
- `api_keys.admin`：管理员 API Key
- `api_keys.user`：普通用户 API Key

请联系系统管理员获取。

### Q5: 忘记了 API Key 怎么办？

请联系系统管理员重新获取 API Key，或查看服务器上的 `config.yaml` 配置文件。

---

## 附录：截图占位说明

本文档中的截图占位符需要替换为实际截图：

| 占位符 | 说明 |
|--------|------|
| `screenshots/login.png` | 登录页面 |
| `screenshots/admin-dashboard.png` | 管理员仪表盘 |
| `screenshots/admin-auth-test.png` | 认证测试结果 |
| `screenshots/admin-providers.png` | SSO 平台列表 |
| `screenshots/admin-provider-form.png` | 添加/编辑平台表单 |
| `screenshots/admin-provider-detail.png` | 平台详情页面 |
| `screenshots/admin-logs.png` | 操作日志页面 |
| `screenshots/admin-log-detail.png` | 日志详情展开 |
| `screenshots/user-home.png` | 用户首页 |
| `screenshots/user-providers.png` | 用户平台列表 |
| `screenshots/user-fields.png` | 字段账号管理 |
| `screenshots/user-field-form.png` | 添加/编辑字段表单 |
| `screenshots/cache-status.png` | 缓存状态 |

建议在项目根目录创建 `screenshots` 文件夹存放截图文件。
